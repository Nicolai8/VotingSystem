/*!
// backbone.stickit - v0.8.0
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
*/
(function(n){typeof define=="function"&&define.amd?define(["underscore","backbone","exports"],n):typeof exports=="object"?n(require("underscore"),require("backbone"),exports):n(_,Backbone,{})})(function(n,t,i){i._handlers=[];i.addHandler=function(t){t=n.map(n.flatten([t]),function(t){return n.extend({updateModel:!0,updateView:!0,updateMethod:"text"},t)});this._handlers=this._handlers.concat(t)};i.ViewMixin={_modelBindings:null,unstickit:function(t,i){if(n.isObject(i)){n.each(n.keys(i),function(n){this.unstickit(t,n)},this);return}var r=[],u=[];n.each(this._modelBindings,function(n,f){t&&n.model!==t||i&&n.config.selector!=i||(u.push(n.config._destroy),n.model.off(n.event,n.fn),r.push(n.model),delete this._modelBindings[f])},this);n.invoke(n.uniq(r),"trigger","stickit:unstuck",this.cid);n.each(n.uniq(u),function(n){n.call(this)},this);this._modelBindings=n.compact(this._modelBindings);this.$el.off(".stickit"+(t?"."+t.cid:""),i)},stickit:function(t,i){var u=t||this.model,f=i||n.result(this,"bindings")||{},r;this._modelBindings||(this._modelBindings=[]);this.addBinding(u,f);r=this.remove;r.stickitWrapped||(this.remove=function(){var n=this;return this.unstickit(),r&&(n=r.apply(this,arguments)),n});this.remove.stickitWrapped=!0},addBinding:function(t,i,u){var p,g,w,o,b,y=t||this.model,tt=".stickit."+y.cid,k=u||{},nt=n.uniqueId(),d;if(n.isString(i))b=i;else{d=i;n.each(d,function(n,t){this.addBinding(y,t,d[t])},this);return}(p=b===":el"?this.$el:this.$(b),this.unstickit(y,b),p.length)&&(n.isString(k)&&(k={observe:k}),n.isFunction(k.observe)&&(k.observe=k.observe.call(this)),o=l(p,k),o.selector=b,w=o.observe,o.bindId=nt,o.view=this,g=n.extend({stickitChange:o},o.setOptions),o._destroy=function(){r(this,o.destroy,p,y,o)},a(this,p,o,y,w),v(this,p,o,y,w),w&&(n.each(o.events,function(t){var r=t+tt,i=function(t){var i=o.getVal.call(this,p,t,o,n.rest(arguments));s(this,o.updateModel,i,t,o)&&c(y,w,i,g,this,o)};if(i=n.bind(i,this),b===":el")this.$el.on(r,i);else this.$el.on(r,b,i)},this),n.each(n.flatten([w]),function(n){e(y,this,"change:"+n,o,function(n,t,i){var r=i&&i.stickitChange&&i.stickitChange.bindId||null;r!==nt&&h(this,p,o,f(n,w,o,this),n)})},this),h(this,p,o,f(y,w,o,this),y,!0)),r(this,o.initialize,p,y,o))}};n.extend(t.View.prototype,i.ViewMixin);var u=function(t,i){var u=(i||"").split("."),r=n.reduce(u,function(n,t){return n[t]},t);return r==null?t:r},r=function(t,i){if(i)return(n.isString(i)?u(t,i):i).apply(t,n.rest(arguments,2))},o=function(n){return n.find("option").not(function(){return!this.selected})},s=function(t,i){return n.isBoolean(i)?i:n.isFunction(i)||n.isString(i)?r.apply(this,arguments):!1},e=function(n,t,i,r,u){n.on(i,u,t);t._modelBindings.push({model:n,event:i,fn:u,config:r})},c=function(t,i,u,f,e,o){var s={};o.onSet&&(u=r(e,o.onSet,u,o));o.set?r(e,o.set,i,u,f,o):(s[i]=u,n.isArray(i)&&n.isArray(u)&&(s=n.reduce(i,function(t,i,r){return t[i]=n.has(u,r)?u[r]:null,t},{})),t.set(s,f))},f=function(t,i,u,f){var e,o=function(n){return t[u.escape?"escape":"get"](n)},s=function(n){return n==null?"":n};return e=n.isArray(i)?n.map(i,o):o(i),u.onGet&&(e=r(f,u.onGet,e,u)),n.isArray(e)?n.map(e,s):s(e)},l=i.getConfiguration=function(t,r){var f=[{updateModel:!1,updateMethod:"text",update:function(n,t,i,r){n[r.updateMethod]&&n[r.updateMethod](t)},getVal:function(n,t,i){return n[i.updateMethod]()}}],u;return f=f.concat(n.filter(i._handlers,function(n){return t.is(n.selector)})),f.push(r),u=n.extend.apply(n,f),u.visible&&!n.has(u,"updateView")?u.updateView=!1:n.has(u,"updateView")||(u.updateView=!0),u},a=function(t,i,r,u,o){var s=["autofocus","autoplay","async","checked","controls","defer","disabled","hidden","indeterminate","loop","multiple","open","readonly","required","scoped","selected"];n.each(r.attributes||[],function(h){var a="",c,l;h=n.clone(h);c=h.observe||(h.observe=o);l=function(){var e=n.indexOf(s,h.name,!0)>-1?"prop":"attr",r=f(u,c,h,t);h.name==="class"?(i.removeClass(a).addClass(r),a=r):i[e](h.name,r)};n.each(n.flatten([c]),function(n){e(u,t,"change:"+n,r,l)});l()})},v=function(t,i,u,o,s){if(u.visible!=null){var h=function(){var e=u.visible,c=u.visibleFn,l=f(o,s,u,t),h=!!l;(n.isFunction(e)||n.isString(e))&&(h=!!r(t,e,l,u));c?r(t,c,i,h,u):i.toggle(h)};n.each(n.flatten([s]),function(n){e(o,t,"change:"+n,u,h)});h()}},h=function(n,t,i,u,f,e){s(n,i.updateView,u,i)&&(r(n,i.update,t,u,f,i),e||r(n,i.afterUpdate,t,u,i))};return i.addHandler([{selector:'[contenteditable="true"]',updateMethod:"html",events:["input","change"]},{selector:"input",events:["propertychange","input","change"],update:function(n,t){n.val(t)},getVal:function(n){return n.val()}},{selector:"textarea",events:["propertychange","input","change"],update:function(n,t){n.val(t)},getVal:function(n){return n.val()}},{selector:'input[type="radio"]',events:["change"],update:function(n,t){n.filter('[value="'+t+'"]').prop("checked",!0)},getVal:function(n){return n.filter(":checked").val()}},{selector:'input[type="checkbox"]',events:["change"],update:function(i,r){if(i.length>1)r||(r=[]),i.each(function(i,u){var f=t.$(u),e=n.indexOf(r,f.val())>-1;f.prop("checked",e)});else{var u=n.isBoolean(r)?r:r===i.val();i.prop("checked",u)}},getVal:function(i){var r,u;return i.length>1?r=n.reduce(i,function(n,i){var r=t.$(i);return r.prop("checked")&&n.push(r.val()),n},[]):(r=i.prop("checked"),u=i.val(),u!=="on"&&u!=null&&(r=r?i.val():null)),r}},{selector:"select",events:["change"],update:function(i,f,e,o){var h,s=o.selectOptions,c=s&&s.collection||undefined,w=i.prop("multiple"),a,l,b,y,v,p;if(s||(s={},a=function(n){return n.map(function(){return{value:this.value,label:this.text}}).get()},i.find("optgroup").length?(c={opt_labels:[]},i.find("> option").length&&(c.opt_labels.push(undefined),n.each(i.find("> option"),function(n){c[undefined]=a(t.$(n))})),n.each(i.find("optgroup"),function(n){var i=t.$(n).attr("label");c.opt_labels.push(i);c[i]=a(t.$(n).find("option"))})):c=a(i.find("option"))),s.valuePath=s.valuePath||"value",s.labelPath=s.labelPath||"label",l=function(i,r,f){n.each(i,function(i){var o=t.$("<option/>"),e=i,h=function(t,i){o.text(t);e=i;o.data("stickit_bind_val",e);n.isArray(e)||n.isObject(e)||o.val(e)};i==="__default__"?h(s.defaultOption.label,s.defaultOption.value):h(u(i,s.labelPath),u(i,s.valuePath));!w&&e!=null&&f!=null&&e===f||n.isObject(f)&&n.isEqual(e,f)?o.prop("selected",!0):w&&n.isArray(f)&&n.each(f,function(t){n.isObject(t)&&(t=u(t,s.valuePath));(t===e||n.isObject(t)&&n.isEqual(e,t))&&o.prop("selected",!0)});r.append(o)})},i.find("*").remove(),b=function(n,t){var i=window;return t.indexOf("this.")===0&&(i=n),t=t.replace(/^[a-z]*\.(.+)$/,"$1"),u(i,t)},h=n.isString(c)?b(this,c):n.isFunction(c)?r(this,c,i,o):c,h instanceof t.Collection&&(h=h.toJSON()),s.defaultOption&&l(["__default__"],i),n.isArray(h))l(h,i,f);else if(h.opt_labels)n.each(h.opt_labels,function(n){var r=t.$("<optgroup/>").attr("label",n);l(h[n],r,f);i.append(r)});else{y=[];for(p in h)v={},v[s.valuePath]=p,v[s.labelPath]=h[p],y.push(v);l(n.sortBy(y,s.comparator||s.labelPath),i,f)}},getVal:function(n){return n.prop("multiple")?t.$(o(n).map(function(){return t.$(this).data("stickit_bind_val")})).get():o(n).data("stickit_bind_val")}}]),t.Stickit=i,t.Stickit});